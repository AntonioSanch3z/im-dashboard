tosca_definitions_version: tosca_simple_yaml_1_0

imports:
  - ec3_custom_types: https://raw.githubusercontent.com/grycap/ec3/tosca/tosca/custom_types.yaml

metadata:
  name: Nifi
  display_name: Launch an nifi on top of a Kubernetes Virtual Cluster
  icon: images/nifi.png
  parents:
   - kubernetes.yaml

description: TOSCA template for launching an Nifi on top of a Kubernetes Virtual Cluster.

topology_template:
  inputs:

    nifi_admin_username:
      type: string
      description: Name of the full admin user
      default: admin
      required: yes
    nifi_admin_password:
      type: string
      description: Password of the full admin user
      default: nifiadminpassword
      required: yes
      constraints:
       - min_length: 12

  node_templates:

    nifins:
      type: tosca.nodes.indigo.KubernetesObject
      properties:
        spec: |
          apiVersion: v1
          kind: Namespace
          metadata:
            name: 'nifi'
      requirements:
        - host: lrms_front_end

    nifipvc:
      type: tosca.nodes.indigo.KubernetesObject
      properties:
        spec: |
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            namespace: nifi
            name: nifipvc
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 10Gi
      requirements:
        - host: lrms_front_end
        - dependency: nifins

    nifi:
      type: tosca.nodes.indigo.KubernetesObject
      properties:
        spec:
          concat:
            - |-
                apiVersion: apps/v1
                kind: Deployment
                metadata:
                  annotations:
                  labels:
                    app: nifi
                  name: nifi
                  namespace: nifi
                spec:
                  replicas: 1
                  selector:
                    matchLabels:
                      app: nifi
                  template:
                    metadata:
                      labels:
                        app: nifi
                    spec:
                      restartPolicy: Always
                      volumes:
                        - name: nifi
                          persistentVolumeClaim:
                            claimName: nifipvc
                      containers:
                        - name: nifi
                          image: apache/nifi
                          ports:
                            - containerPort: 8443
                          resources:
                            requests:
                              memory: 1536Mi
                              cpu: 1000m
                          startupProbe:
                            failureThreshold: 600
                            periodSeconds: 10
                            tcpSocket:
                              port: 8443
                          livenessProbe:
                            periodSeconds: 20
                            tcpSocket:
                              port: 8443
                          volumeMounts:
                            - name: nifi
                              mountPath: /opt/nifi/nifi-current/database_repository
                              subPath: database_repository
                            - name: nifi
                              mountPath: /opt/nifi/nifi-current/flowfile_repository
                              subPath: flowfile_repository
                            - name: nifi
                              mountPath: /opt/nifi/nifi-current/content_repository
                              subPath: content_repository
                            - name: nifi
                              mountPath: /opt/nifi/nifi-current/provenance_repository
                              subPath: provenance_repository
                            - name: nifi
                              mountPath: /opt/nifi/nifi-current/logs
                              subPath: logs
                            - name: nifi
                              mountPath: /opt/nifi/nifi-current/state
                              subPath: state
                          env:
                            - name: SINGLE_USER_CREDENTIALS_PASSWORD
                              value: '
            - get_input: nifi_admin_password
            - |-
                '
                            - name: SINGLE_USER_CREDENTIALS_USERNAME
                              value: '
            - get_input: nifi_admin_username
            - |-
                '
                            - name: NIFI_WEB_PROXY_HOST
                              value: '
            - get_attribute: [ front, public_address, 0 ]
            - |-
                '
      requirements:
        - host: lrms_front_end
        - dependency: nifins

    nifi_services:
      type: tosca.nodes.indigo.KubernetesObject
      properties:
        spec: |
          apiVersion: v1
          kind: Service
          metadata:
            namespace: nifi
            labels:
              app: nifi
            name: service-nifi
          spec:
            ports:
              - name: '8443'
                port: 8443
                targetPort: 8443
            selector:
              app: nifi
      requirements:
        - host: lrms_front_end
        - dependency: nifins

    nifi_ingress:
      type: tosca.nodes.indigo.KubernetesObject
      properties:
        spec: |
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: nifi
            namespace: nifi
            annotations:
              kubernetes.io/ingress.class: 'nginx'
              nginx.ingress.kubernetes.io/backend-protocol: 'HTTPS'
          spec:
            rules:
            - http:
                paths:
                - path: /nifi
                  backend:
                    service:
                      name: service-nifi
                      port:
                        number: 8443
                  pathType: Prefix
      requirements:
        - host: lrms_front_end
        - dependency: nifins

  outputs:
    nifi_endpoint:
      value: { concat: [ 'https://', get_attribute: [ front, public_address, 0 ], '/nifi/' ] }
